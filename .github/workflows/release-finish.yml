name: Release Finish (Gitflow)

on:
  workflow_call:
    inputs:
      release_branch:
        description: 'Release branch to finish (e.g., release/2.0.16)'
        required: true
        type: string
      next_version_increment:
        description: 'Next version increment type for master'
        required: false
        type: string
        default: 'minor'
      next_version:
        description: 'Or specify exact next version for master (e.g., 2.1.0-SNAPSHOT)'
        required: false
        type: string
      runner:
        description: 'Runner to use for jobs'
        required: false
        type: string
        default: "ubuntu-24.04"
      java_version:
        description: 'Java version to use'
        required: false
        type: number
        default: 21
      java_distribution:
        description: 'Java distribution to use'
        required: false
        type: string
        default: "liberica"
      version_tag_prefix:
        description: 'Prefix for version tags'
        required: false
        type: string
        default: "v"
      artifact_group_id:
        description: 'Maven group ID for summary links (e.g., io.entur)'
        required: false
        type: string
        default: ""
      artifact_ids:
        description: 'Comma-separated artifact IDs for summary links (e.g., my-library,my-cli)'
        required: false
        type: string
        default: ""
    secrets:
      SONATYPE_AUTH_USER:
        required: true
      SONATYPE_AUTH_TOKEN:
        required: true
      SONATYPE_GPG_KEY_PUBLIC:
        required: true
      SONATYPE_GPG_KEY:
        required: true
      SONATYPE_GPG_KEY_PASSWORD:
        required: true
  workflow_dispatch:
    inputs:
      release_branch:
        description: 'Release branch to finish (e.g., release/2.0.16)'
        required: true
        type: string
      next_version_increment:
        description: 'Next version increment type for master'
        required: false
        type: choice
        default: 'minor'
        options:
          - major
          - minor
          - patch
      next_version:
        description: 'Or specify exact next version for master (e.g., 2.1.0-SNAPSHOT)'
        required: false
        type: string

jobs:
  get-release-version:
    runs-on: ${{ inputs.runner || 'ubuntu-24.04' }}
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.release_branch }}
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java_version || 21 }}
          distribution: ${{ inputs.java_distribution || 'liberica' }}

      - name: Get release version
        id: get_version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          # Remove -SNAPSHOT if present
          VERSION="${VERSION%-SNAPSHOT}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

  create-tag:
    name: Create release tag
    needs: get-release-version
    runs-on: ${{ inputs.runner || 'ubuntu-24.04' }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.release_branch }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create and push tag
        run: |
          VERSION="${{ needs.get-release-version.outputs.version }}"
          TAG="${{ inputs.version_tag_prefix || 'v' }}${VERSION}"

          echo "Creating tag: $TAG from branch ${{ inputs.release_branch }}"
          git tag -a "$TAG" -m "Release $VERSION"
          git push origin "$TAG"

  publish-release:
    name: Publish to Maven Central
    needs: [get-release-version, create-tag]
    runs-on: ${{ inputs.runner || 'ubuntu-24.04' }}
    env:
      JRELEASER_MAVENCENTRAL_URL: "https://central.sonatype.com/api/v1/publisher"
      JRELEASER_DEPLOY_MAVEN_MAVENCENTRAL_ACTIVE: "RELEASE"
      JRELEASER_DEPLOY_MAVEN_NEXUS2_ACTIVE: "SNAPSHOT"
      JRELEASER_NEXUS2_URL: "https://ossrh-staging-api.central.sonatype.com/service/local"
      JRELEASER_NEXUS2_SNAPSHOT_URL: "https://central.sonatype.com/repository/maven-snapshots"
      JRELEASER_OVERWRITE: true
      JRELEASER_UPDATE: true
      JRELEASER_GIT_ROOT_SEARCH: true
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.version_tag_prefix || 'v' }}${{ needs.get-release-version.outputs.version }}
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java_version || 21 }}
          distribution: ${{ inputs.java_distribution || 'liberica' }}

      - name: JReleaser Release to Maven Central
        uses: ./.github/actions/jreleaser-release
        with:
          version: ${{ needs.get-release-version.outputs.version }}
          version_tag_prefix: ${{ inputs.version_tag_prefix || 'v' }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          sonatype_username: ${{ secrets.SONATYPE_AUTH_USER }}
          sonatype_password: ${{ secrets.SONATYPE_AUTH_TOKEN }}
          gpg_public_key: ${{ secrets.SONATYPE_GPG_KEY_PUBLIC }}
          gpg_secret_key: ${{ secrets.SONATYPE_GPG_KEY }}
          gpg_passphrase: ${{ secrets.SONATYPE_GPG_KEY_PASSWORD }}

  update-master:
    name: Update master to next SNAPSHOT version
    needs: [get-release-version, publish-release]
    runs-on: ${{ inputs.runner || 'ubuntu-24.04' }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java_version || 21 }}
          distribution: ${{ inputs.java_distribution || 'liberica' }}

      - name: Calculate next development version
        id: next_version
        run: |
          chmod +x .github/scripts/next-version.sh

          CURRENT_VERSION="${{ needs.get-release-version.outputs.version }}"

          # Use custom version if provided, otherwise increment
          if [ -n "${{ inputs.next_version }}" ]; then
            NEXT_VERSION="${{ inputs.next_version }}"
            # Ensure it has -SNAPSHOT
            if [[ ! "$NEXT_VERSION" =~ -SNAPSHOT$ ]]; then
              NEXT_VERSION="${NEXT_VERSION}-SNAPSHOT"
            fi
          else
            INCREMENT_TYPE="${{ inputs.next_version_increment }}"
            NEXT_VERSION=$(.github/scripts/next-version.sh "$CURRENT_VERSION" "$INCREMENT_TYPE")
          fi

          echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "Next development version: $NEXT_VERSION"

      - name: Update master version
        run: |
          NEXT_VERSION="${{ steps.next_version.outputs.next_version }}"
          echo "Updating master to: $NEXT_VERSION"

          mvn -B versions:set -DnewVersion="$NEXT_VERSION" -DgenerateBackupPoms=false -DprocessAllModules=true

          git add '*/pom.xml' pom.xml
          git commit -m "chore: prepare for next development iteration $NEXT_VERSION [skip ci]"
          git push origin master

      - name: Delete release branch
        continue-on-error: true
        run: |
          RELEASE_BRANCH="${{ inputs.release_branch }}"
          echo "Deleting release branch: $RELEASE_BRANCH"
          git push origin --delete "$RELEASE_BRANCH" || echo "Branch already deleted"

      - name: Create summary
        run: |
          VERSION="${{ needs.get-release-version.outputs.version }}"
          TAG_PREFIX="${{ inputs.version_tag_prefix || 'v' }}"
          GROUP_ID="${{ inputs.artifact_group_id }}"
          ARTIFACT_IDS="${{ inputs.artifact_ids }}"

          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## Release Finished

          - **Released Version:** $VERSION
          - **Git Tag:** \`${TAG_PREFIX}${VERSION}\`
          EOF

          # Add Maven Central links if artifact details are provided
          if [ -n "$GROUP_ID" ] && [ -n "$ARTIFACT_IDS" ]; then
            IFS=',' read -ra ARTIFACTS <<< "$ARTIFACT_IDS"
            for ARTIFACT_ID in "${ARTIFACTS[@]}"; do
              ARTIFACT_ID=$(echo "$ARTIFACT_ID" | xargs)  # Trim whitespace
              echo "- **Maven Central ($ARTIFACT_ID):** https://central.sonatype.com/artifact/${GROUP_ID}/${ARTIFACT_ID}/${VERSION}" >> $GITHUB_STEP_SUMMARY
            done
          fi

          cat >> $GITHUB_STEP_SUMMARY <<EOF
          - **Next Development Version (master):** ${{ steps.next_version.outputs.next_version }}
          - **Release Branch:** Deleted

          The release has been published to Maven Central and master branch has been updated to the next development version.
          EOF